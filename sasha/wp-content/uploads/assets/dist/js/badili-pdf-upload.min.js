app.controller("pdfUploadCtrl",["$scope","$rootScope",function(a,b){a.author_list=[],a.author_list.push(a.guid()),a.contributor_list=[],a.contributor_list.push(a.guid()),a.clearForm=function(){a["abstract"]="",a.action="",a.author="",a.contributors="",a.creation_date=new Date,a.filedata="",a.filename="",a.filesize="",a.filesizebytes="",a.filetype="",a.keywords="",a.language="en",a.publisher="",a.rights="",a.subject="",a.title="",a.number_of_pages="",a.safeApply()},a.uploadFile=function(){if($("#PdfDetailsForm").valid()){a.authors=[],jQuery('[name="pdf_authors"').each(function(){var b=$(this).val();""!==b&&a.authors.push(b)}),a.contributors=[],jQuery('[name="pdf_contributors"').each(function(){var b=$(this).val();""!==b&&a.contributors.push(b)});var c={action:"upload_document",title:a.title,"abstract":a["abstract"],authors:JSON.stringify(a.authors),file_biblio:a.file_biblio,file_identifier:a.file_identifier,creation_date:moment(new Date(a.creation_date)).format("YYYY-MM-DD"),subject:a.subject,topics:JSON.stringify(b.final_topics),topics_tax:JSON.stringify(b.topics_tax),publisher:a.publisher,language:a.language,rights:a.rights,contributors:JSON.stringify(a.contributors),keywords:a.keywords,filesize:a.filesizebytes,filename:a.filename,filetype:a.filetype,filedata:a.filedata,number_of_pages:a.number_of_pages};a.send_ajax_request(c,function(a){"success"==a.status&&(window.location.href=a.url)},function(a){console.log("Error",a)})}},$(document).on("change","input[type=file]",function(){var b=$(this).attr("id"),c=$(this)[0].files[0];switch(b){case"pdf-select":a.uploadTheFile(c,function(b,d,e){if("success"==b){var f={action:"get_document_meta",filename:c.name,filedata:d,filetype:c.type};a.send_ajax_request(f,function(b){"success"==b.status&&(a.clearForm(),$("#number_of_pages").closest(".form-group").addClass("hidden"),/image\/*/.test(c.type)?(a.creation_date=b.meta.DateTimeOriginal?a.get_value(b.meta.DateTimeOriginal).toDate("yyyy-mm-dd hh:ii:ss"):"",$('[name="pdf_authors"]').val(a.get_value(b.meta.Author)),a.title=a.get_value(b.meta.Title),a.subject=a.get_value(b.meta.Subject)):/application\/pdf/.test(c.type)&&(a.creation_date=b.meta.CreationDate?new Date(a.get_value(b.meta.CreationDate)):"",a.number_of_pages=a.get_value(b.meta.Pages),a.keywords=a.get_value(b.meta["AAPL:Keywords"]),$('[name="pdf_authors"]').val(a.get_value(b.meta.Author)),a.title=a.get_value(b.meta.Title),a.subject=a.get_value(b.meta.Subject),$("#number_of_pages").closest(".form-group").removeClass("hidden")),a.filedata=d,a.filename=c.name,a.filetype=c.type,a.filesize=a.bytesToMbs(c.size),a.filesizebytes=c.size,a.safeApply())},function(a){console.log("Error",a)})}else"failure"==b&&console.log("Failure","Upload failed: "+e)})}}),$(document).on("click","#add_pdf_author",function(){a.author_list.push(a.guid()),a.safeApply()}),$(document).on("click","#add_pdf_contributor",function(){a.contributor_list.push(a.guid()),a.safeApply()}),a.removeAuthor=function(b){a.author_list=a.author_list.filter(function(a){return a!==b})},a.removeContributor=function(b){a.contributor_list=a.contributor_list.filter(function(a){return a!==b})}}]);
